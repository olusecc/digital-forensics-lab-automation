input {
  file {
    path => "/data/processed/autopsy/*.json"
    start_position => "beginning"
    sincedb_path => "/dev/null"
    codec => "json"
    type => "autopsy"
    tags => ["forensics", "autopsy"]
  }
  file {
    path => "/data/processed/volatility/*.json"
    start_position => "beginning"
    sincedb_path => "/dev/null"
    codec => "json"
    type => "volatility"
    tags => ["forensics", "memory"]
  }
  file {
    path => "/data/processed/andriller/*.json"
    start_position => "beginning"
    sincedb_path => "/dev/null"
    codec => "json"
    type => "andriller"
    tags => ["forensics", "mobile"]
  }
  file {
    path => "/data/processed/cape/*.json"
    start_position => "beginning"
    sincedb_path => "/dev/null"
    codec => "json"
    type => "cape"
    tags => ["forensics", "malware"]
  }
  beats {
    port => 5044
  }
}

filter {
  # Add timestamp processing
  mutate { 
    add_field => { "timestamp" => "%{@timestamp}" } 
  }

  # Parse Autopsy data
  if [type] == "autopsy" {
    if [timestamp] {
      date {
        match => [ "timestamp", "yyyy-MM-dd HH:mm:ss", "ISO8601" ]
        target => "@timestamp"
      }
    }
    
    if [file_path] {
      grok {
        match => { "file_path" => "(?<file_directory>.*)/(?<file_name>[^/]+)$" }
      }
      
      grok {
        match => { "file_name" => ".*\.(?<file_extension>[^.]+)$" }
      }
    }
  }

  # Parse Volatility data
  if [type] == "volatility" {
    if [process_name] and [pid] {
      mutate {
        add_field => { "process_key" => "%{process_name}-%{pid}" }
      }
    }
  }

  # Parse mobile data
  if [type] == "andriller" {
    if [app_name] {
      mutate {
        add_field => { "device_type" => "mobile" }
      }
    }
  }

  # Parse malware analysis
  if [type] == "cape" {
    if [malware_family] {
      mutate {
        add_field => { "threat_type" => "malware" }
      }
    }
  }

  # Add case metadata
  if [case_id] {
    mutate {
      add_field => { "lab_processed" => true }
      add_field => { "processing_time" => "%{@timestamp}" }
    }
  }
}

output {
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "forensics-%{type}-%{+YYYY.MM.dd}"
  }
  
  stdout {
    codec => rubydebug
  }
}

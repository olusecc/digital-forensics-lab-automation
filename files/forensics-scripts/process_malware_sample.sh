#!/bin/bash
# Basic Malware Analysis Script (YARA scanning and file analysis)
set -e

SAMPLE_FILE="$1"
OUTPUT_DIR="$2"
CASE_ID="$3"

if [ $# -ne 3 ]; then
    echo "Usage: $0 <sample_file> <output_dir> <case_id>"
    exit 1
fi

echo "[$(date)] Starting malware analysis for case: $CASE_ID"

# Create output directories
mkdir -p "$OUTPUT_DIR"
mkdir -p "/data/processed/cape"

# Basic file analysis
echo "[$(date)] Performing basic file analysis..."
file "$SAMPLE_FILE" > "$OUTPUT_DIR/file_type.txt"
sha256sum "$SAMPLE_FILE" > "$OUTPUT_DIR/file_hash.txt"
SAMPLE_HASH=$(sha256sum "$SAMPLE_FILE" | cut -d' ' -f1)

# YARA scanning (if rules exist)
echo "[$(date)] Running YARA scans..."
if [ -d "/opt/yara-rules" ]; then
    yara -r /opt/yara-rules "$SAMPLE_FILE" > "$OUTPUT_DIR/yara_matches.txt" || echo "No YARA matches found"
else
    echo "No YARA rules found" > "$OUTPUT_DIR/yara_matches.txt"
fi

# String analysis
echo "[$(date)] Extracting strings..."
strings "$SAMPLE_FILE" | head -1000 > "$OUTPUT_DIR/strings.txt"

# Convert results to JSON
echo "[$(date)] Converting to JSON format..."
python3 /opt/forensics/scripts/malware_to_json.py "$OUTPUT_DIR" "$CASE_ID" "$SAMPLE_HASH"

echo "[$(date)] Malware analysis completed for case: $CASE_ID"
#!/usr/bin/env python3
import json
import sys
import os
from datetime import datetime

def process_malware_analysis(output_dir, case_id, sample_hash):
    """Process malware analysis results"""
    results = []
    
    # Process different analysis files
    files_to_process = {
        'file_type.txt': 'file_analysis',
        'yara_matches.txt': 'yara_results',
        'strings.txt': 'string_analysis'
    }
    
    for filename, analysis_type in files_to_process.items():
        file_path = os.path.join(output_dir, filename)
        if os.path.exists(file_path):
            try:
                with open(file_path, 'r', encoding='utf-8', errors='ignore') as f:
                    content = f.read()
                    
                    result = {
                        '@timestamp': datetime.now().isoformat(),
                        'case_id': case_id,
                        'sample_hash': sample_hash,
                        'type': 'cape',
                        'source': analysis_type,
                        'content': content[:5000],  # First 5000 chars
                        'file_size': len(content),
                        'processed_time': datetime.now().isoformat()
                    }
                    
                    # Add specific fields for YARA matches
                    if analysis_type == 'yara_results' and content.strip():
                        result['yara_matches'] = True
                        result['malware_detected'] = True
                    
                    results.append(result)
                    
            except Exception as e:
                print(f"Error processing {filename}: {e}")
    
    return results

def main():
    if len(sys.argv) != 4:
        print("Usage: malware_to_json.py <output_directory> <case_id> <sample_hash>")
        sys.exit(1)
    
    output_dir = sys.argv[1]
    case_id = sys.argv[2]
    sample_hash = sys.argv[3]
    
    json_dir = '/data/processed/cape'
    os.makedirs(json_dir, exist_ok=True)
    
    results = process_malware_analysis(output_dir, case_id, sample_hash)
    
    if results:
        timestamp = int(datetime.now().timestamp())
        output_file = os.path.join(json_dir, f'malware_{case_id}_{timestamp}.json')
        with open(output_file, 'w') as f:
            for result in results:
                f.write(json.dumps(result) + '\n')
        print(f"Malware analysis: {len(results)} entries written to {output_file}")
    else:
        print("No malware analysis data to process")

if __name__ == '__main__':
    main()